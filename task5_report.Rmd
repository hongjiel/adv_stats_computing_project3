---
title: "P8160 Report - Bayesian Modeling of Hurricane Trajectories"
author: "Hongjie Liu, Xicheng Xie, Jiajun Tao, Zijian Xu, Shaohan Chen"
date: "5/1/2023"
output:
  pdf_document:
    number_sections: true
    toc: yes
    toc_depth: 2
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
header-includes:
- \usepackage{fancyhdr}
- \usepackage{lipsum}
- \pagestyle{fancy}
- \fancyhead[R]{\thepage}
- \fancypagestyle{plain}{\pagestyle{fancy}}
- \usepackage{algorithm} 
- \usepackage{algpseudocode} 
- \usepackage{amsthm}
- \usepackage{bm}
- \usepackage{subfigure}
- \usepackage{graphicx}
- \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
```

\newpage 
# Introduction
## Background
A hurricane is a powerful tropical storm characterized by high winds, heavy rain, storm surges, and flooding. Hurricanes are also known as cyclones or typhoons, depending on the region where they occur.

Hurricanes typically form over warm ocean waters and can travel for thousands of miles, causing widespread destruction and disruption to communities in their path. They are categorized on a scale of 1 to 5 based on their wind speed and potential for damage, with Category 5 being the most severe.

Hurricanes can cause significant damage to infrastructure, homes, and businesses, and can also result in loss of life. As such, it is essential to take precautions and follow instructions from emergency management officials in the event of a hurricane.

## Motivation
Climate researcher are interested in modeling hurricane trajectories for early warning and preparedness, resource allocation, planning and response, and scientific research. Overall, accurate modeling of hurricane trajectories is essential for mitigating the impact of hurricanes on communities, infrastructure, and the environment, as well as for advancing our scientific understanding of these powerful storms.

In this project, we are particularly interested in forecasting the wind speed of hurricanes.

## Dataset
The dataset, `hurrican703.csv`, collected the track data of 702 hurricanes in the North Atlantic area from 1950 to 2013. For all the storms, their location (longitude & latitude) and maximum wind speed were recorded every 6 hours. The data includes the following variables:
\begin{itemize}
\item ID: ID of the hurricanes
\item Season: In which year the hurricane occurred
\item Month: In which month the hurricane occurred
\item Nature: Nature of the hurricane
  ET: Extra Tropical
  
  DS: Disturbance
  
  NR: Not Rated
  
  SS: Sub Tropical
  
  TS: Tropical Storm

\item Time: dates and time of the record
\item Latitude and Longitude: The location of a hurricane check point
\item Wind.kt Maximum wind speed (in Knot) at each check point
\end{itemize}

## Data pre-processing
First we need to pre-process the data. We only kept observations that occurred on 6 consecutive hour intervals. Through this step, we found that some hurricanes had the same ID but were actually different ones (eg. ALICE). Hurricanes that had fewer than 3 observations were excluded. For the purpose of seasonal comparison, we defined August, September, and October as hurricane-active season, and the rest as hurricane-inactive season. After data cleaning, there are 21691 observations across 704 unique hurricanes.

# Bayesian Model

## Bayesian hierarchical model for wind speed

# MCMC

## Posterior distribution of the parameters

## MCMC algorithm implementation

## Parameter convergence diagnostic

## Methods of MCMC
To estimate the parameters of the posterior distribution corresponding to the above calculation by collecting samples, we will use the MCMC method. We will apply Gibbs sampling steps to the parameters of the known conditional distribution, and use the Metropolis-Hastings (MH) method for the parameters of the unknown conditional distribution, specifically for $sigma$. For the other parameters, we will use Gibbs sampling.

Before explaining the algorithm in detail, let's define the hyperparameters:
- $\lambda$ is the acceptance rate of the MH algorithm.
- $a$ represents the search window used in the MH algorithm.
- $burnin$ indicates the starting iteration number for collecting samples.

To begin this algorithm, for each iteration, we firstly Initialize the values of $\boldsymbol{\beta}_i^{(0)}$ ${\mu}^{(0)}$,$\boldsymbol{\Sigma}^{(0)}$, $\boldsymbol\gamma^{(0)}$, $\sigma^{(0)}$to some value we obtain from lmm model. 

- Next For each iteration $k=1,2,\ldots$: Sample $\boldsymbol{\beta}_i^{(k)}$ from $\pi(\boldsymbol\beta_i\mid \boldsymbol{\mu}^{(k-1)},\boldsymbol{\Sigma}^{(k-1)},\boldsymbol\gamma^{(k-1)},\sigma^{(k-1)},\boldsymbol{Y}^\top)$ 
sample $\boldsymbol{\mu}^{(k)}$ from $\pi(\boldsymbol{\mu}\mid\mathbf B^{(k)}, \boldsymbol{\Sigma}^{(k-1)},\boldsymbol{\gamma}^{(k-1)}, \sigma^{(k-1)}, \boldsymbol{Y}^\top)$
sample $\boldsymbol{\Sigma}^{(k)}$ from $\pi(\boldsymbol{\Sigma}\mid \mathbf B^{(k)}, \boldsymbol{\mu}^{(k)}, \boldsymbol\gamma^{(k-1)}, \sigma^{(k-1)}, \mathbf{Y}^\top)$
Sample $\boldsymbol{\gamma}^{(k)}$ from $\pi(\boldsymbol{\gamma}\mid \mathbf B^{(k)}, \boldsymbol{\mu}^{(k)}, \boldsymbol\Sigma^{(k)},\sigma^{(k-1)}, \mathbf{Y}^\top)$

- For each MH step, after obtaining $\boldsymbol{\beta}_i^{(k)}$, ${\mu}^{(k)}$, $\boldsymbol{\Sigma}^{(k)}$, and $\boldsymbol\gamma^{(k)}$ in the $k^{th}$ iteration, we assume that $sigma^{k}_i$ follows a U($sigma^{k-1}_i$-a, $sigma^{k-1}_i$+a) distribution. Then, we generate a candidate $\sigma^*$ from that distribution and calculate the acceptance ratio $\lambda$.\par $\lambda=\frac{\pi(\sigma^*|\mathbf{Y}, \boldsymbol{\beta}^{(k)}, \boldsymbol{\mu}^{(k)}, \boldsymbol{\Sigma}^{(k)},\boldsymbol\gamma^{(k)})}{\pi(\sigma^{(k-1)}|\mathbf{Y}, \boldsymbol{\beta}^{(k)}, \boldsymbol{\mu}^{(k)}, \boldsymbol{\Sigma}^{(k)}, \boldsymbol\gamma^{(k)})}$\par
At the same time we compute the acceptance probability, $\alpha$, as the minimum of 1 and the acceptance ratio: $\alpha=\min(1,\lambda)$. We compare that number with a random number $u$ from a uniform distribution, $\text{Uniform}(0,1)$.If $u \leq \alpha$, accept the proposed value and set $\sigma^{(k)} = \sigma^*$, otherwise reject the proposed value and set $\sigma^{(k)} = \sigma^{(k-1)}$.

- Repeat this loop for a total of iternum=10000 times, recording the sample values of each parameter.

## Starting Value of MCMC
\textbf{Initial Value Selection}
\begin{itemize}
\item $\boldsymbol{\beta}_i$: This can be obtained through the random effects term in the lmm model. The random effects term can be added to the fixed effects term to obtain $\boldsymbol{\beta}_i^{(0)}$.
\item $\boldsymbol{\mu}$: This can be obtained through the fixed effects of intercept, windpre, latdiff, longdiff, winddiff term.
\item $\boldsymbol{\gamma}$: This can be obtained through the fixed effects of Year, Active Month, and Nature term.
\item $\sigma$: This can be obtained through the model residual.
\item $\boldsymbol{\Sigma}$: This can be obtained through the `VarCorr` function which returns the covariance matrix of the random effects in the model $\boldsymbol{\Sigma}^{(0)}$.
\end{itemize}

\textbf{Speficic Value}
\begin{table}[h]
    \centering
    \caption{Initial Value Setting}
    \begin{tabular}{|c|c|}
        \hline
        Parameter & Value \\
        \hline
        $\boldsymbol{\mu}^\top$ & $(24.25, 0.94, -0.02, -0.24, 0.47)$ \\
        $\boldsymbol{\gamma}^\top$ & $(-0.01, 0.35, 0.28, 0.37, 0.12, 0.08)$ \\
        $\boldsymbol{\Sigma}$ & $\begin{pmatrix}
           0.358 & -0.010 & 0.039 & 0.121 & 0.028 \\
           -0.01 & 0.001 & -0.003 & -0.005 & 0.002 \\
           0.039 & -0.003 & 0.043 & 0.034 & -0.019 \\
           0.121 & -0.005 & 0.034 & 0.069 & 0.003 \\
           0.028 & 0.002 & -0.019 & 0.003 & 0.017 \\
        \end{pmatrix}$ \\
        $\sigma$ & 5.27 \\
        \hline
    \end{tabular}
\end{table}


## Parameter convergence diagnostic
### Trace plot
\begin{figure} 
  \centering 
  \subfigure[mu]{ 
    \label{sub1}
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/Mu_parameters_time_series_plot.png} 
  } 
  \subfigure[Sigma matrix]{ 
    \label{sub2} 
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/Sigma_parameters_time_series_plot.png} 
  } \\
  \subfigure[gamma]{ 
    \label{sub3} 
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/Gamma_parameters_time_series_plot.png} 
  } 
  \subfigure[sigma]{ 
    \label{sub4} 
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/igma_parameters_time_series_plot.png} 
  } 
  \label{para1} 
\end{figure}

Through trace plots, it can be seen that the convergence speed of each parameter is very fast, and after 1000 iterations, all parameters except the intercept of $\mu$ have converged with fluctuations, while the others have reached convergence.

\newpage



### Autocorrelation plot

The autocorrelation plots of each parameter for the 500 iterations after burn-in are shown below:

\begin{figure} 
  \centering 
  \subfigure[mu]{ 
    \label{sub1}
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/Mu_Parameters_ACF_Plot.png} 
  } 
  \subfigure[Sigma matrix]{ 
    \label{sub2} 
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/Sigma_Parameters_ACF_Plot.png} 
  } \\
  \subfigure[gamma]{ 
    \label{sub3} 
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/Gamma_Parameters_ACF_Plot.png} 
  } 
  \subfigure[sigma]{ 
    \label{sub4} 
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/igma_Parameters_ACF_Plot.png} 
  } 
  \label{para1} 
\end{figure}

It can be seen from the plots that the autocorrelation of each parameter decreases rapidly and eventually stabilizes near zero.

### Histogram plot
\begin{figure} 
  \centering 
  \subfigure[mu]{ 
    \label{sub1}
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/Mu_Parameters_Histogram_Plot.png} 
  } 
  \subfigure[Sigma matrix]{ 
    \label{sub2} 
    \includegraphics[width=2.0in, height = 1.4in]{parameters_burnin/Sigma_Parameters_Histogram_Plot.png} 
  } 
  \label{para1} 
\end{figure}

\newpage

## Hyperparameter Value of choosing
\textbf{Hyperparameter Value}
\begin{itemize}
 \item Search window $a=0.1$ 
 \item Burn-in $=8000$ 
 \item Resulting acceptance rate $=0.418$ 
\end{itemize}

## Posterior summaries of gamma 
Posterior summaries and 95% credible intervals of $\gamma$ is shown in table \ref{table:sum} and table \ref{table:ci}. We are mainly interested in answering two questions. Are there seasonal differences in hurricane wind speeds? Is there evidence to support the claim that hurricane wind speeds have been increasing over the years? The convergence of parameter $\gamma_{year}$ and $\gamma_{active}$ is shown in figure \ref{Year} and figure \ref{Active}. The two parameters converged after MCMC, and $\gamma_{active}$ had a better performance on convergence than $\gamma_{year}$. Thus we could answer the two questions using the 95% credible intervals. Since the credible intervals for both parameters contain zero, the conclusion is that there is no seasonal or yearly difference in hurricane wind speeds.

## Hurricane wind speed prediction
Given parameters $\bm{\gamma}$ and $\bm{\beta_i}$ which is the coefficients associated the $i$th hurricane, the predicted wind speed of the $i$-th hurricane at $t+6$ time stamp, denoted as $\hat{Y}_i(t+6)$ could be computed as:
$$\hat{Y}_i(t+6) = \bm{\beta_i}^T \mathbf{Z_i}(t) + \mathbf{X_i}\bm{\gamma}$$
where $\bm{\beta_i} = (\beta_{0,i}, \beta_{1,i}, ..., \beta_{4,i})$, and $\mathbf{Z_i}(t) = (1, \ Y_i(t), \ \Delta_{i,1}(t), \ \Delta_{i,2}(t), \ \Delta_{i,3}(t))$.\par

Based on the burn-in number $8000$ as concluded in MCMC parameter convergence diagnostic section, we calculated the parameters to be used to make prediction, and predict the wind speeds of each hurricane at each time stamp, except for the first two time stamps. We computed the RMSE and R-squared of each hurricane, as partly shown in the table \ref{table:summary}. It can be observed that different hurricanes perform variously on RMSE and R-squared. Generally the RMSE for selected hurricanes is around $3$ to $8$, and the R-squared is within $0.7$ to $1.0$. However, there is also extremely low R-squared($0.30$ as shown) and high RMSE($9.64$ as shown).\par

The prediction performance on several chosen example hurricanes is shown in figure \ref{Time series prediction plot} and figure \ref{Prediction vs. observation}. As shown in figure\ref{Time series prediction plot}, the predicted wind speed overall nicely fit the observed wind speed at each time index of those hurricanes, though performance is better on example hurricane 'ABLE.1951' than other examples. According to figure\ref{Prediction vs. observation}, the prediction and observation data points fit well as a linear line with slope $=1$. Digging deeper, the Bayesian model performs much better when the wind speed is stable, but worse when there exits some fluctuations of wind speed. More specifically, the Bayesian model's prediction has a latency in responding to the fluctuation of observed wind speed, and the changing of predicted speed is generally one unit time index behind observed speed.\par

The overall RMSE performance of difference hurricanes is shown in figure \ref{RMSE distribution}. And the overall R-squared performance of difference hurricanes is shown in figure \ref{$R^2$ distribution}. The RMSE follows an very right-skewed distribution, with most RMSEs distributed around $2$ to $6$, and distribution peak is around $3.5$. The distribution of R-squared then follows a very left-skewed distribution with most of the values distributed from $0.875$ to $1$, and the peak is around $0.94$. There also exists some extremely large RMSEs and small R-squareds, which may need further investigation.\par

Furthermore, we examined the distribution of RMSE across various properties of hurricanes is shown in figure \ref{RMSE under different natures} and figure \ref{RMSE under different months}. We observed that hurricanes belong to nature of "Not Rated" and "Tropical Storm" have an average higher RMSE than other hurricanes. Besides, hurricanes happening in summer from June to September, also have higher RMSE than other months.\par


# Discussion
## MCMC parameters convergence problem

## Prediction latency of wind speed change

# Group Contributions {-}



\newpage 
# Appendices {-}

## Figures and Tables {-}
\begin{table}[h]
\centering
\small
\caption{Posterior Summaries of $\gamma$}
\label{table:sum}
\begin{tabular}{llcc}
\hline
\textbf{parameter} & \textbf{Mean} & \textbf{Standard Deviation} & \textbf{Median} \\ \hline
$\gamma_{year}$ & -0.010 & 0.009 & -0.011 \\
$\gamma_{active}$ & 0.002 & 0.053 & 0.002 \\
$\gamma_{ET}$ & 0.003 & 0.050 & 0.003 \\
$\gamma_{NR}$ & 0.0002 & 0.049 & -0.0003 \\
$\gamma_{SS}$ & 0.005 & 0.050 & 0.005 \\
$\gamma_{TS}$ & 0.01 & 0.057 & 0.01 \\\hline
\end{tabular}
\end{table}

\begin{table}[h]
\centering
\small
\caption{95\% Credible Intervals of $\gamma$}
\label{table:ci}
\begin{tabular}{lll}
\hline
\textbf{parameter} & \textbf{2.5\% Quantile} & \textbf{97.5\% Quantile} \\ \hline
$\gamma_{year}$ & -0.029 & 0.008  \\
$\gamma_{active}$ & -0.102 & 0.104  \\
$\gamma_{ET}$ & -0.096 & 0.098  \\
$\gamma_{NR}$ & -0.098 & 0.095  \\
$\gamma_{SS}$ & -0.096 & 0.104  \\
$\gamma_{TS}$ & -0.105 & 0.119  \\\hline
\end{tabular}
\end{table}

\begin{table}[h]
\centering
\small
\caption{Summary of RMSE and R-squared for selected hurricanes}
\label{table:summary}
\begin{tabular}{llcc}
\hline
\textbf{ID} & \textbf{Year} & \textbf{RMSE} & \textbf{R-squared} \\ \hline
ABBY.1960 & 1960 & 8.8804 & 0.7700 \\
ABBY.1964 & 1964 & 9.6430 & 0.3033 \\
ABBY.1968 & 1968 & 3.5043 & 0.9360 \\
ABLE.1950 & 1950 & 3.6755 & 0.9813 \\
ABLE.1951 & 1951 & 3.4802 & 0.9767 \\
ABLE.1952 & 1952 & 4.5183 & 0.9583 \\
AGNES.1972 & 1972 & 5.2483 & 0.8881 \\
ALBERTO.1982 & 1982 & 8.0473 & 0.7499 \\
ALBERTO.1988 & 1988 & 2.6121 & 0.7420 \\
ALBERTO.1994 & 1994 & 4.3941 & 0.8807 \\
ALBERTO.2000 & 2000 & 3.7896 & 0.9625 \\
ALBERTO.2006 & 2006 & 4.3591 & 0.7882 \\
ALBERTO.2012 & 2012 & 3.2193 & 0.8036 \\
ALEX.1998 & 1998 & 2.9351 & 0.7289 \\
ALEX.2004 & 2004 & 5.4552 & 0.9539 \\ \hline
\end{tabular}
\end{table}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\textwidth]{jacky_part_pic/year.png}
  \caption{Time series plot of $\gamma_{year}$}
  \label{Year}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\textwidth]{jacky_part_pic/active.png}
  \caption{Time series plot of $\gamma_{active}$}
  \label{Active}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\textwidth]{predic_plots/b_merge.png}
  \caption{Time series prediction plot}
  \label{Time series prediction plot}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\textwidth]{predic_plots/a_1_4.png}
  \caption{Prediction vs. observation}
  \label{Prediction vs. observation}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\textwidth]{predic_plots/rmse1.png}
  \caption{RMSE distribution}
  \label{RMSE distribution}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\textwidth]{predic_plots/R_square.png}
  \caption{$R^2$ distribution}
  \label{$R^2$ distribution}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\textwidth]{predic_plots/rmse_nature.png}
  \caption{RMSE under different natures}
  \label{RMSE under different natures}
\end{figure}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\textwidth]{predic_plots/months1.png}
  \caption{RMSE under different months}
  \label{RMSE under different months}
\end{figure}

